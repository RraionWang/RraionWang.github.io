# 获取微信公众号关注用户数量

<div>
  <button id="fetchTokenButton">获取关注用户数量</button>
  <input type="text" id="userCount" readonly style="width: 200px;" placeholder="用户数量将显示在这里">
</div>

<script>
  // 微信公众号相关配置
  const appId = 'wx981676074758a2ee'; // 替换为你的微信公众号 AppID
  const appSecret = '9293dec15810033f5ea4075004c22584'; // 替换为你的微信公众号 AppSecret
  let accessToken = null;
  let tokenExpiresAt = 0;

  // 获取 access_token
  async function fetchAccessToken() {
    const url = `https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${appId}&secret=${appSecret}`;
    try {
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`获取 access_token 失败: ${response.statusText}`);
      }
      const data = await response.json();
      if (data.access_token) {
        accessToken = data.access_token;
        tokenExpiresAt = Date.now() + (data.expires_in * 1000); // 设置过期时间
        console.log('Access Token:', accessToken);
      } else {
        throw new Error(`获取 access_token 失败: ${JSON.stringify(data)}`);
      }
    } catch (error) {
      console.error(error);
      alert('获取 access_token 出错，请检查控制台日志');
    }
  }

  // 获取关注用户数量
  async function fetchUserCount() {
    if (!accessToken || Date.now() >= tokenExpiresAt) {
      await fetchAccessToken(); // 如果 token 过期或不存在，重新获取
    }
    if (!accessToken) return;

    const url = `https://api.weixin.qq.com/cgi-bin/user/get?access_token=${accessToken}`;
    try {
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`获取用户数量失败: ${response.statusText}`);
      }
      const data = await response.json();
      if (data.total) {
        document.getElementById('userCount').value = data.total; // 显示用户数量
        console.log('用户数量:', data.total);
      } else {
        throw new Error(`获取用户数量失败: ${JSON.stringify(data)}`);
      }
    } catch (error) {
      console.error(error);
      alert('获取用户数量出错，请检查控制台日志');
    }
  }

  // 绑定按钮点击事件
  document.getElementById('fetchTokenButton').addEventListener('click', fetchUserCount);

  // 每小时自动更新一次
  setInterval(fetchUserCount, 60 * 60 * 1000);
</script>